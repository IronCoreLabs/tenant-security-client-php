# Re-key Example

In order to run this example, you need to be running a _Tenant Security Proxy_ (TSP) on your machine.
Check the [README.md](../README.md) file in the parent directory to see how to start the TSP, if you haven't done so
yet.

Once the TSP is running, you can experiment with this example php program. It illustrates the basics of how
to use the Tenant Security Client (TSC) re-key function. The example code contains 3 parts:

1. encryption and decryption of a file, using the file-system for storage
2. reading the EDEK from the file-system, re-keying it to a different tenant, then storing it again
3. reading the new EDEK from the file-system then using it to decrypt to document for the new tenant

To run the example, you will need to have a PHP 7.3+ and composer installed on your computer.

```bash
export API_KEY='0WUaXesNgbTAuLwn'
composer update
php src/main.php
```

We've assigned an API key for you, but in production you will make your own and edit the TSP
configuration with it. This should produce output like:

```
Using tenant tenant-gcp-l
Decrypted SSN: 000-12-2345
Decrypted address: 2825-519 Stone Creek Rd, Bozeman, MT 59715
Decrypted name: Jim Bridger
Wrote encrypted file to success.jpg.enc
Wrote edek to success.jpg.edek
Wrote decrypted file to decrypted.jpg
```

The decrypted output is printed after round-tripping encryption and decryption of the customer record.

If you look in the current directory, you'll find a _success.jpg_ file. The example code encrypted
that file to produce a _success.jpg.enc_ file containing the encrypted file data, and a second file
_success.jpg.edek_ that contains the Encrypted Data Encryption Key (EDEK) that is required to
decrypt the file. It then used that EDEK to decrypt the _.enc_ file, writing a _decrypted.jpg_ file.

If you do a `cksum success.jpg decrypted.jpg`, you can confirm that the decrypted file is identical
to the original.

When you run the example, you should see a number of INFO outputs generated by your TSP indicating
that it was wrapping a new DEK using the KMS, then unwrapping an EDEK.

## Additional Resources

If you would like some more in-depth information, our website features a section of technical
documentation about the [SaaS Shield product](https://ironcorelabs.com/docs/saas-shield/).
